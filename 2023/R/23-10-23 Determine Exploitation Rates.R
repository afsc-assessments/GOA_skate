##=========================================##
#     Get the exploitation Rate for Skates  #
#       Date Created: 10/23/23              #
#       Last Modified: 10/23/23             #
##=========================================##


library(here)
library(tidyverse)
library(dbplyr)
library(scico)  # color scheme for ggplot for color blind people
ggplot2::theme_set(afscassess::theme_report())

cur_yr <- 2023

skate_bio <- read.csv(here(cur_yr,"data","output",paste(cur_yr,"Skate_Total_index.csv", sep = "-"))) %>%
  filter(year >= 2005)

# Big Skates
bg_catch <- read.csv(here(cur_yr,"data","output",paste(cur_yr,"Big_Skate_OFL_catch.csv", sep = "-")))
bg_exploit <- bg_catch %>%
  select(year,total_catch) %>%
  left_join(skate_bio %>%
              select(year,big_pred), by = "year") %>%
  mutate(xrate = total_catch/big_pred) %>%
  add_column(Species = "Big Skate") %>%
  rename(pred_bio = big_pred)


# Longnose
ln_catch <- read.csv(here(cur_yr,"data","output",paste(cur_yr,"Longnose_Skate_OFL_catch.csv", sep = "-")))
ln_exploit <- ln_catch %>%
  select(year,total_catch) %>%
  left_join(skate_bio %>%
              select(year,ln_pred), by = "year") %>%
  mutate(xrate = total_catch/ln_pred) %>%
  add_column(Species = "Longnose Skate") %>%
  rename(pred_bio = ln_pred)


# Other Skates
ot_catch <- read.csv(here(cur_yr,"data","output",paste(cur_yr,"Other_Skate_OFL_catch.csv", sep = "-")))
ot_exploit <- ot_catch %>%
  select(year,total_catch) %>%
  left_join(skate_bio %>%
              select(year,ot_pred), by = "year") %>%
  mutate(xrate = total_catch/ot_pred) %>%
  add_column(Species = "Other Skates") %>%
  rename(pred_bio = ot_pred)



ex_tot <- bg_exploit %>%
  bind_rows(ln_exploit) %>%
  bind_rows(ot_exploit) 
  



p_exploit <- ggplot(data = ex_tot, aes(x = year, y = xrate, color = Species)) +
  geom_point() +
  geom_line() +
  scale_color_manual(values = c("#7E1700", "#C7B354","#023198")) +
  geom_hline(yintercept = mean(bg_exploit$xrate), lty = 2,  col = "#7E1700") +
  geom_hline(yintercept = mean(ln_exploit$xrate), lty = 2, col = '#C7B354') +
  geom_hline(yintercept = mean(ot_exploit$xrate), lty = 2, col = '#023198') +
  theme(panel.grid.major = element_line(linewidth = 0.5)) +
  theme(axis.line = element_line()) +
  theme(axis.ticks = element_line(colour = "black")) +
  scale_y_continuous(labels = scales::comma) +  labs(x = "Year", y = 'Catch/Biomass', title = '') 

print(p_exploit)

ggsave(here::here(cur_yr, "figs", paste(cur_yr,"All_Skate_exploitation_rate.png",sep = "_")), dpi = 300, units = 'in',
       height = 4, width = 7,bg = 'white')



## exploitation rate by strata ##
catch_strata <- read.csv(here(cur_yr,"data","output", paste(cur_yr,"Skate_strata_catch.csv",sep = "-"))) %>%
  filter(year >= 2005)

# Big skate
bg_bio_strata <- read.csv(here(cur_yr, "data", "output", paste(cur_yr,"Calculate_biomass_strata_big_skate.csv", sep = "-"))) %>%
  select(year,W_bio,C_bio,E_bio) %>%
  filter(year >= 2005,
         year <= cur_yr) %>%
  pivot_longer(cols = c(W_bio,C_bio,E_bio), values_to = "pred_bio") %>%
  mutate(strata = case_when(name =="C_bio" ~ "CGOA",
                            name =="E_bio" ~ "EGOA",
                            name =="W_bio" ~ "WGOA")) %>%
  select(-name) %>%
  left_join(catch_strata %>%
              filter(assess_group == 'big_skate'), by = c('year',"strata")) %>%
  mutate(xrate = catch_wght/pred_bio)

# used to get the mean value by each area
temp <- bg_bio_strata %>%
  select(year,strata,xrate) %>%
  pivot_wider(names_from = strata, values_from = xrate)

p_bg_exploit <- ggplot(data = bg_bio_strata, aes(x = year, y = xrate, color = strata)) +
  geom_point() +
  geom_line() +
  scale_color_manual(values = c("#7E1700", "#C7B354","#023198")) +
  geom_hline(yintercept = mean(temp$CGOA), lty = 2,  col = "#7E1700") +
  geom_hline(yintercept = mean(temp$EGOA), lty = 2, col = '#C7B354') +
  geom_hline(yintercept = mean(temp$WGOA), lty = 2, col = '#023198') +
  theme(panel.grid.major = element_line(linewidth = 0.5)) +
  theme(axis.line = element_line()) +
  theme(axis.ticks = element_line(colour = "black")) +
  scale_y_continuous(labels = scales::comma) +  labs(x = "Year", y = 'Catch/Biomass', title = '') 

# print(p_bg_exploit)


# Big skate
ln_bio_strata <- read.csv(here(cur_yr, "data", "output", paste(cur_yr,"Calculate_biomass_strata_longnose_skate.csv", sep = "-"))) %>%
  select(year,W_bio,C_bio,E_bio) %>%
  filter(year >= 2005,
         year <= cur_yr) %>%
  pivot_longer(cols = c(W_bio,C_bio,E_bio), values_to = "pred_bio") %>%
  mutate(strata = case_when(name =="C_bio" ~ "CGOA",
                            name =="E_bio" ~ "EGOA",
                            name =="W_bio" ~ "WGOA")) %>%
  select(-name) %>%
  left_join(catch_strata %>%
              filter(assess_group == 'longnose_skate'), by = c('year',"strata")) %>%
  mutate(xrate = catch_wght/pred_bio)

# used to get the mean value by each area
temp <- ln_bio_strata %>%
  select(year,strata,xrate) %>%
  pivot_wider(names_from = strata, values_from = xrate)

p_ln_exploit <- ggplot(data = ln_bio_strata, aes(x = year, y = xrate, color = strata)) +
  geom_point() +
  geom_line() +
  scale_color_manual(values = c("#7E1700", "#C7B354","#023198")) +
  geom_hline(yintercept = mean(temp$CGOA), lty = 2,  col = "#7E1700") +
  geom_hline(yintercept = mean(temp$EGOA), lty = 2, col = '#C7B354') +
  geom_hline(yintercept = mean(temp$WGOA), lty = 2, col = '#023198') +
  theme(panel.grid.major = element_line(linewidth = 0.5)) +
  theme(axis.line = element_line()) +
  theme(axis.ticks = element_line(colour = "black")) +
  scale_y_continuous(labels = scales::comma) +  labs(x = "Year", y = 'Catch/Biomass', title = '') 

# print(p_ln_exploit)


strata_tot <- bg_bio_strata %>%
  bind_rows(ln_bio_strata) %>%
  mutate(Species = case_when(assess_group =="big_skate" ~ "Big Skate",
                             assess_group =="longnose_skate" ~ "Longnose Skate")) %>%
  rename(Area = strata)
  



p_strata_exploit <- ggplot(data = strata_tot, aes(x = year, y = xrate, color = Area)) +
  geom_point() +
  geom_line() +
  facet_grid(rows = vars(Species), scales = "free_y") +
  scale_color_manual(values = c("#7E1700", "#C7B354","#023198")) +
  geom_hline(yintercept = mean(temp$CGOA), lty = 2,  col = "#7E1700") +
  geom_hline(yintercept = mean(temp$EGOA), lty = 2, col = '#C7B354') +
  geom_hline(yintercept = mean(temp$WGOA), lty = 2, col = '#023198') +
  theme(panel.grid.major = element_line(linewidth = 0.5)) +
  theme(axis.line = element_line()) +
  theme(axis.ticks = element_line(colour = "black")) +
  scale_y_continuous(labels = scales::comma) +  labs(x = "Year", y = 'Catch/Biomass', title = '') 

print(p_strata_exploit)

ggsave(here::here(cur_yr, "figs", paste(cur_yr,"Area_Skate_exploitation_rate.png",sep = "_")), dpi = 300, units = 'in',
       height = 4, width = 7,bg = 'white')
